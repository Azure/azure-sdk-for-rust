{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "15654619800087055533"
    }
  },
  "parameters": {
    "adminUser": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "Kubernetes cluster admin user name."
      }
    },
    "baseName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "minLength": 6,
      "maxLength": 23,
      "metadata": {
        "description": "The base resource name."
      }
    },
    "deployResources": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy resources. When set to false, this file deploys nothing."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location of the resource. By default, this is the same as the resource group."
      }
    },
    "sshPubKey": {
      "type": "string",
      "defaultValue": ""
    }
  },
  "variables": {
    "acrPull": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
    "storageAccountContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]"
  },
  "resources": [
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-08-01",
      "name": "[format('sa{0}', uniqueString(parameters('baseName')))]",
      "kind": "StorageV2",
      "location": "[parameters('location')]",
      "properties": {
        "accessTier": "Hot"
      },
      "sku": {
        "name": "Standard_LRS"
      }
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-08-01",
      "name": "[format('sa2{0}', uniqueString(parameters('baseName')))]",
      "kind": "StorageV2",
      "location": "[parameters('location')]",
      "properties": {
        "accessTier": "Hot"
      },
      "sku": {
        "name": "Standard_LRS"
      }
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2018-11-30",
      "name": "[parameters('baseName')]",
      "location": "[parameters('location')]"
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('sa2{0}', uniqueString(parameters('baseName'))))]",
      "name": "[guid(resourceGroup().id, variables('storageAccountContributor'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')))]",
      "properties": {
        "principalId": "[if(parameters('deployResources'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')), '2018-11-30').principalId, '')]",
        "principalType": "ServicePrincipal",
        "roleDefinitionId": "[variables('storageAccountContributor')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('sa2{0}', uniqueString(parameters('baseName'))))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName'))]"
      ]
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-01-01-preview",
      "name": "[uniqueString(resourceGroup().id)]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Basic"
      }
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', uniqueString(resourceGroup().id))]",
      "name": "[guid(resourceGroup().id, variables('acrPull'), 'containerInstance')]",
      "properties": {
        "principalId": "[if(parameters('deployResources'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')), '2018-11-30').principalId, '')]",
        "principalType": "ServicePrincipal",
        "roleDefinitionId": "[variables('acrPull')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', uniqueString(resourceGroup().id))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName'))]"
      ]
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.ContainerService/managedClusters",
      "apiVersion": "2023-06-01",
      "name": "[parameters('baseName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "agentPoolProfiles": [
          {
            "count": 1,
            "enableAutoScaling": false,
            "kubeletDiskType": "OS",
            "mode": "System",
            "name": "agentpool",
            "osDiskSizeGB": 128,
            "osDiskType": "Managed",
            "osSKU": "Ubuntu",
            "osType": "Linux",
            "type": "VirtualMachineScaleSets",
            "vmSize": "Standard_D2s_v3"
          }
        ],
        "dnsPrefix": "identitytest",
        "enableRBAC": true,
        "linuxProfile": {
          "adminUsername": "[parameters('adminUser')]",
          "ssh": {
            "publicKeys": [
              {
                "keyData": "[parameters('sshPubKey')]"
              }
            ]
          }
        },
        "oidcIssuerProfile": {
          "enabled": true
        },
        "securityProfile": {
          "workloadIdentity": {
            "enabled": true
          }
        }
      }
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-05-01",
      "name": "[format('fnst{0}', uniqueString(parameters('baseName')))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2"
      }
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[format('asp-{0}', parameters('baseName'))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "P1V2",
        "tier": "PremiumV2"
      },
      "kind": "linux",
      "properties": {
        "reserved": true
      }
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[format('func-{0}', parameters('baseName'))]",
      "location": "[parameters('location')]",
      "kind": "functionapp,linux",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')))]": {}
        }
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('asp-{0}', parameters('baseName')))]",
        "reserved": true,
        "siteConfig": {
          "linuxFxVersion": "CUSTOM",
          "appSettings": [
            {
              "name": "AzureWebJobsStorage",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', format('fnst{0}', uniqueString(parameters('baseName'))), listKeys(resourceId('Microsoft.Storage/storageAccounts', format('fnst{0}', uniqueString(parameters('baseName')))), '2023-05-01').keys[0].value, environment().suffixes.storage)]"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "custom"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', format('asp-{0}', parameters('baseName')))]",
        "[resourceId('Microsoft.Storage/storageAccounts', format('fnst{0}', uniqueString(parameters('baseName'))))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName'))]"
      ]
    },
    {
      "condition": "[parameters('deployResources')]",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('sa2{0}', uniqueString(parameters('baseName'))))]",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', format('sa2{0}', uniqueString(parameters('baseName')))), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')), 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')), '2018-11-30').principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('sa2{0}', uniqueString(parameters('baseName'))))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName'))]"
      ]
    }
  ],
  "outputs": {
    "IDENTITY_ACR_LOGIN_SERVER": {
      "type": "string",
      "value": "[if(parameters('deployResources'), reference(resourceId('Microsoft.ContainerRegistry/registries', uniqueString(resourceGroup().id)), '2023-01-01-preview').loginServer, '')]"
    },
    "IDENTITY_ACR_NAME": {
      "type": "string",
      "value": "[if(parameters('deployResources'), uniqueString(resourceGroup().id), '')]"
    },
    "IDENTITY_AKS_NAME": {
      "type": "string",
      "value": "[if(parameters('deployResources'), parameters('baseName'), '')]"
    },
    "IDENTITY_STORAGE_ID": {
      "type": "string",
      "value": "[if(parameters('deployResources'), resourceId('Microsoft.Storage/storageAccounts', format('sa{0}', uniqueString(parameters('baseName')))), '')]"
    },
    "IDENTITY_STORAGE_NAME_SYSTEM_ASSIGNED": {
      "type": "string",
      "value": "[if(parameters('deployResources'), format('sa{0}', uniqueString(parameters('baseName'))), '')]"
    },
    "IDENTITY_STORAGE_NAME_USER_ASSIGNED": {
      "type": "string",
      "value": "[if(parameters('deployResources'), format('sa2{0}', uniqueString(parameters('baseName'))), '')]"
    },
    "IDENTITY_USER_ASSIGNED_IDENTITY": {
      "type": "string",
      "value": "[if(parameters('deployResources'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')), '')]"
    },
    "IDENTITY_USER_ASSIGNED_IDENTITY_CLIENT_ID": {
      "type": "string",
      "value": "[if(parameters('deployResources'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')), '2018-11-30').clientId, '')]"
    },
    "IDENTITY_USER_ASSIGNED_IDENTITY_NAME": {
      "type": "string",
      "value": "[if(parameters('deployResources'), parameters('baseName'), '')]"
    },
    "IDENTITY_USER_ASSIGNED_IDENTITY_OBJECT_ID": {
      "type": "string",
      "value": "[if(parameters('deployResources'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('baseName')), '2018-11-30').principalId, '')]"
    },
    "IDENTITY_FUNCTIONAPP_NAME": {
      "type": "string",
      "value": "[if(parameters('deployResources'), format('func-{0}', parameters('baseName')), '')]"
    },
    "IDENTITY_FUNCTIONAPP_DEFAULT_HOSTNAME": {
      "type": "string",
      "value": "[if(parameters('deployResources'), reference(resourceId('Microsoft.Web/sites', format('func-{0}', parameters('baseName'))), '2023-12-01').defaultHostName, '')]"
    }
  }
}