name: Check All Features for Services

on:
  workflow_dispatch:

env:
  # the goal is to remove warnings from the generated code
  # https://github.com/Azure/azure-sdk-for-rust/issues/553
  RUSTFLAGS: -Dwarnings -Aunused_attributes -Aunreachable-code -Aunused-assignments -Adead-code -Aclippy::new-without-default
  CARGO_INCREMENTAL: 0

jobs:
  get_service_crates:
    runs-on: ubuntu-latest
    outputs:
      members: ${{ steps.get_members.outputs.members }}
    steps:
      - uses: actions/checkout@v3
      - id: get_members
        run: |
          MEMBERS=$(cargo metadata --format-version=1 --no-deps | jq -c '.packages | .[] | select(.publish == null) | .name' | jq -s '.' | jq -c '.')
          echo members=${MEMBERS} >> $GITHUB_OUTPUT
        working-directory: services

  check_service_crates:
    name: Check ${{ matrix.crate }}
    runs-on: ubuntu-latest
    needs: get_service_crates
    strategy:
      fail-fast: false
      matrix:
        crate: ${{ fromJSON(needs.get_service_crates.outputs.members) }}
    steps:
      - uses: actions/checkout@v3
      - run: rustup update --no-self-update stable
      - run: cargo check --all-features -p ${{ matrix.crate }}
        working-directory: services
