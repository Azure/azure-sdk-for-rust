parameters:
  - name: RustToolchain
    type: string
    default: stable

steps:
  - template: /eng/pipelines/templates/steps/use-rust.yml@self
    parameters:
      Toolchain: ${{ parameters.RustToolchain }}

  - pwsh: |
      . ./eng/common/scripts/Helpers/CommandInvocation-Helpers.ps1

      $env:RUSTDOCFLAGS = "-D warnings"
      $env:RUSTFLAGS = "-Dwarnings"

      Invoke-LoggedCommand "cargo +$(RustToolchain) check -p azure_core --no-default-features"
      Invoke-LoggedCommand "cargo +$(RustToolchain) install cargo-readme"
      Invoke-LoggedCommand "cargo +$(RustToolchain) fmt --all -- --check"
      Invoke-LoggedCommand "cargo +$(RustToolchain) clippy --all"
      Invoke-LoggedCommand "cargo +$(RustToolchain) doc --all --no-deps"
    displayName: "Run source analysis"
