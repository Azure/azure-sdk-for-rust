parameters:
  - name: Toolchain
    type: string
    default: stable

steps:
  - template: /eng/pipelines/templates/steps/use-rust.yml@self
    parameters:
      Toolchain: ${{ parameters.Toolchain }}

  # using -Zscript with verify-dependencies.rs requires nightly be installed
  - ${{ if ne(parameters.Toolchain, 'nightly') }}:
      - template: /eng/pipelines/templates/steps/use-rust.yml@self
        parameters:
          Toolchain: ${{ parameters.Toolchain }}

  - pwsh: |
      . ./eng/common/scripts/Helpers/CommandInvocation-Helpers.ps1

      $env:RUSTDOCFLAGS = "-D warnings"
      $env:RUSTFLAGS = "-Dwarnings"

      Invoke-LoggedCommand "cargo +$(Toolchain) check -p azure_core --no-default-features"
      Invoke-LoggedCommand "cargo +$(Toolchain) fmt --all -- --check"
      Invoke-LoggedCommand "cargo +$(Toolchain) clippy --all"
      Invoke-LoggedCommand "cargo +$(Toolchain) doc --all --no-deps"
      Invoke-LoggedCommand "cargo +nightly -Zscript ./eng/scripts/verify-dependencies.rs"
    displayName: "Run source analysis"
