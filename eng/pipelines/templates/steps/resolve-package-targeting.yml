parameters:
  - name: BuildTargetingString
    type: string
    default: "azure-*"
  - name: PackagePropertiesFolder
    type: string
    default: ""

steps:
  # if triggered for a PR, handle PR diff side adding the default for packageproperties folder will mean this will always act
  # as a non-pr resolution
  - ? ${{ if and(eq(variables['Build.Reason'], 'PullRequest'), ne(parameters.PackagePropertiesFolder, '')) }}
    : - pwsh: |
          $packageProperties = Get-ChildItem -Recurse -Force "${{ parameters.PackagePropertiesFolder }}" `
            | Where-Object { $_.Extension -eq '.json' } `
            | Foreach-Object { $_.Name } `
            | ForEach-Object { $_.Replace(".json", "") }
          $setting = $packageProperties -join ","
          Write-Host "Setting TargetingString to $setting"
          Write-Host "##vso[task.setvariable variable=TargetingString;]$setting"
        displayName: Set PR TargetingString variable
  # if not triggered for a PR, simply attempt to locate the targeted packages from the service directory combined with runtime variable.
  - ${{ else }}:
      - pwsh: |
          # output (variable BuildTargetingString) ?? (parameter BuildTargetingString) to the variable TargetingString

          # if the BuildTargetingString variable is not set, it'll just come back as the variable name. otherwise it's set.
          if ('$(BuildTargetingString)' -ne ('$' + '(BuildTargetingString)')) {
            Write-Host 'The variable named BuildTargetingString is set to "$(BuildTargetingString)"'
            $setting = '$(BuildTargetingString)'
          }
          else {
            Write-Host 'We are falling back to the parameter value ${{ parameters.BuildTargetingString }}'
            $setting = '${{ parameters.BuildTargetingString }}'
          }

          Write-Host "Setting TargetingString to $setting"
          Write-Host "##vso[task.setvariable variable=TargetingString;]$setting"
        displayName: Set TargetingString variable
        condition: and(succeededOrFailed(), eq(variables['TargetingString'],''))
