parameters:
  - name: ServiceDirectory
    type: string
    default: ""
  - name: BuildTargetingString
    type: string
    default: "*"
  - name: RustToolchain
    type: string
    default: stable
  - name: ArtifactSuffix
    type: string
    default: "linux"
  - name: PublishArtifacts
    type: boolean
    default: false
  - name: UnitTests
    type: boolean
    default: false
  - name: FunctionalTests
    type: boolean
    default: false
  - name: TestTimeoutInMinutes
    type: number
    default: 60

steps:
  - template: /eng/pipelines/templates/steps/use-rust.yml@self
    parameters:
      Toolchain: ${{ parameters.RustToolchain }}

  - template: /eng/common/pipelines/templates/steps/set-default-branch.yml@self

  - script: |
      echo "##vso[build.addbuildtag]Scheduled"
    displayName: "Tag scheduled builds"
    condition: and(eq(variables['Build.SourceBranchName'], variables['DefaultBranch']), eq(variables['Build.Reason'],'Schedule'))

  # now we need to call Save-Package-Properties so that we can filter on it
  - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
      - pwsh: |
          mkdir -p $(Build.ArtifactStagingDirectory)/diff
        displayName: Create PR Diff Folder

      - pwsh: |
          $location = Join-Path "$(Build.ArtifactStagingDirectory)" "diff"

          Write-Host "./eng/common/scripts/Generate-PR-Diff.ps1 -TargetPath `"$(Build.SourcesDirectory)`" -ArtifactPath `"$location`""
          ./eng/common/scripts/Generate-PR-Diff.ps1 -TargetPath "$(Build.SourcesDirectory)" -ArtifactPath "$location"
        displayName: Generate PR Diff

      - pwsh: |
          Write-Host "Freshly generated the PR diff:"
          Get-ChildItem -R -Force $(Build.ArtifactStagingDirectory)/diff | % { $_.FullName }
          cat $(Build.ArtifactStagingDirectory)/diff/diff.json
        displayName: Dump PR Diff

      - task: Powershell@2
        displayName: Save package properties filtered for PR
        inputs:
          filePath: $(Build.SourcesDirectory)/eng/common/scripts/Save-Package-Properties.ps1
          arguments: >
            -PrDiff $(Build.ArtifactStagingDirectory)/diff/diff.json
            -OutDirectory $(Build.ArtifactStagingDirectory)/PackageInfo
          pwsh: true

  - ${{ else }}:
      - task: Powershell@2
        displayName: Save package properties with dev version
        condition: and(succeeded(), eq(variables['SetDevVersion'],'true'))
        inputs:
          filePath: $(Build.SourcesDirectory)/eng/common/scripts/Save-Package-Properties.ps1
          arguments: >
            -ServiceDirectory ${{parameters.ServiceDirectory}}
            -OutDirectory $(Build.ArtifactStagingDirectory)/PackageInfo
            -AddDevVersion
          pwsh: true
      - task: Powershell@2
        displayName: Save package properties for service
        condition: and(succeeded(), ne(variables['SetDevVersion'],'true'))
        inputs:
          filePath: $(Build.SourcesDirectory)/eng/common/scripts/Save-Package-Properties.ps1
          arguments: >
            -ServiceDirectory ${{parameters.ServiceDirectory}}
            -OutDirectory $(Build.ArtifactStagingDirectory)/PackageInfo
          pwsh: true

  - template: /eng/pipelines/templates/steps/resolve-package-targeting.yml
    parameters:
      BuildTargetingString: ${{ parameters.BuildTargetingString }}
      PackagePropertiesFolder: $(Build.ArtifactStagingDirectory)/PackageInfo

  - task: Powershell@2
    displayName: "Test Packages"
    timeoutInMinutes: ${{ parameters.TestTimeoutInMinutes }}
    env:
      CIBW_BUILD_VERBOSITY: 3
    inputs:
      pwsh: true
      filePath: $(Build.SourcesDirectory)/eng/scripts/Test-Packages.ps1
      arguments: >
        -ServiceDirectory '${{ parameters.ServiceDirectory }}'
        -TargetingString '$(TargetingString)'
        -Toolchain '$(RustToolchain)'
        -UnitTests $${{ parameters.UnitTests }}
        -FunctionalTests $${{ parameters.FunctionalTests }}

  - ${{ if parameters.PublishArtifacts}}:
      - template: /eng/common/pipelines/templates/steps/publish-1es-artifact.yml
        parameters:
          ArtifactPath: "$(Build.ArtifactStagingDirectory)"
          ArtifactName: "packages_${{ parameters.ArtifactSuffix }}"
