parameters:
- name: ServiceDirectory
  type: string

# required matrix parameters
- name: UsePlatformContainer
  type: boolean
- name: OSName
  type: string
- name: Matrix
  type: object
- name: DependsOn
  type: string
- name: CloudConfig
  type: object

jobs:
- job:
  displayName: Semver Check
  condition: and(succeeded(), ne(variables['Skip.Semver'], 'true'))
  dependsOn: ${{ parameters.DependsOn }}

  strategy:
    matrix: $[ ${{ parameters.Matrix }} ]

  pool:
    name: $(Pool)
    # 1es pipeline templates converts `image` to demands: ImageOverride under the hood
    # which is incompatible with image selection in the default non-1es hosted pools
    ${{ if eq(parameters.OSName, 'macOS') }}:
      vmImage: $(OSVmImage)
    ${{ else }}:
      image: $(OSVmImage)
    os: ${{ parameters.OSName }}


  steps:
  - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
    parameters:
      paths:
      - "/*"

  - template: /eng/pipelines/templates/steps/use-rust.yml@self
    parameters:
      Toolchain: stable

  - template: /eng/pipelines/templates/steps/vcpkg.yml

  - template: /eng/common/pipelines/templates/steps/set-default-branch.yml@self

  - template: /eng/common/pipelines/templates/steps/save-package-properties.yml@self
    parameters:
      ServiceDirectory: ${{ parameters.ServiceDirectory }}
      PackageInfoDirectory: $(Build.ArtifactStagingDirectory)/PackageInfo

  - task: PowerShell@2
    displayName: Check SemVer compatibility
    condition: and(succeeded(), ne(variables['NoPackagesChanged'],'true'))
    inputs:
      pwsh: true
      filePath: $(Build.SourcesDirectory)/eng/scripts/Test-Semver.ps1
      arguments: >
        -PackageInfoDirectory '$(Build.ArtifactStagingDirectory)/PackageInfo'
