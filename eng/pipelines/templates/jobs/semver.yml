parameters:
- name: ServiceDirectory
  type: string

jobs:
- job: Semver
  displayName: Semver Check
  condition: and(succeeded(), ne(variables['Skip.Semver'], 'true'))

  pool:
    os: linux
    name: $(LINUXPOOL)
    image: $(LINUXVMIMAGE)

  steps:
  - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
    parameters:
      paths:
      - "/*"

  - template: /eng/pipelines/templates/steps/use-rust.yml@self
    parameters:
      Toolchain: stable

  - template: /eng/pipelines/templates/steps/vcpkg.yml

  - template: /eng/common/pipelines/templates/steps/set-default-branch.yml@self

  - template: /eng/common/pipelines/templates/steps/save-package-properties.yml@self
    parameters:
      ServiceDirectory: ${{ parameters.ServiceDirectory }}
      PackageInfoDirectory: $(Build.ArtifactStagingDirectory)/PackageInfo

  - task: PowerShell@2
    displayName: Check SemVer compatibility
    condition: >-
      and(
        succeeded(),
        ne(variables['NoPackagesChanged'],'true'),
        eq(variables['RustToolchainName'], 'stable')
      )
    inputs:
      pwsh: true
      filePath: $(Build.SourcesDirectory)/eng/scripts/Test-Semver.ps1
      arguments: >
        -PackageInfoDirectory '$(Build.ArtifactStagingDirectory)/PackageInfo'
