parameters:
  - name: ServiceDirectory
    type: string
    default: ""
  - name: BuildTargetingString
    type: string
    default: "azure-*"
  - name: BeforeTestSteps
    type: object
    default: []
  - name: AfterTestSteps
    type: object
    default: []
  - name: TestTimeoutInMinutes
    type: number
    default: 60
  - name: BuildDocs
    type: boolean
    default: true
  - name: TestProxy
    type: boolean
    default: false
  - name: TestPipeline
    type: boolean
    default: false
  - name: GenerateApiReviewForManualOnly
    type: boolean
    default: false
  - name: BuildMatrix
    type: object
    default:
      - pool:
          os: linux
          name: $(LINUXPOOL)
          image: $(LINUXVMIMAGE)
        RustToolchains: [stable, msrv, nightly]
      - pool:
          os: windows
          name: $(WINDOWSPOOL)
          image: $(WINDOWSVMIMAGE)
        RustToolchains: [stable, msrv, nightly]
      - pool:
          os: macOS
          name: $(MACPOOL)
          vmImage: $(MACVMIMAGE)
        RustToolchains: [stable, msrv, nightly]
  - name: AnalyzeToolchains
    type: object
    default: [stable]

jobs:
  - ${{ each matrix in parameters.BuildMatrix }}:
      - ${{ each RustToolchain in matrix.RustToolchains }}:
          - job: Build_${{ matrix.pool.os }}_${{ RustToolchain }}
            timeoutInMinutes: 90

            pool: ${{ matrix.pool }}

            steps:
              - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
                parameters:
                  Paths: [/*]

              - template: /eng/pipelines/templates/steps/test-packages.yml
                parameters:
                  ServiceDirectory: ${{ parameters.ServiceDirectory }}
                  BuildTargetingString: ${{ parameters.BuildTargetingString }}
                  RustToolchain: ${{ RustToolchain }}
                  ArtifactSuffix: ${{ matrix.pool.os }}_${{ RustToolchain }}
                  PublishArtifacts: ${{ and(eq(matrix.pool.os, 'linux'), eq(RustToolchain, 'stable')) }}
                  UnitTests: true
                  FunctionalTests: ${{ ne(variables['Build.Reason'], 'PullRequest') }}

  - ${{ each RustToolchain in parameters.AnalyzeToolchains }}:
      - job: "Analyze_${{ RustToolchain }}"
        condition: and(succeededOrFailed(), ne(variables['Skip.Analyze'], 'true'))
        timeoutInMinutes: ${{ parameters.TestTimeoutInMinutes }}

        pool:
          os: linux
          name: $(LINUXPOOL)
          image: $(LINUXVMIMAGE)

        steps:
          - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
            parameters:
              Paths: [/*]

          - template: /eng/pipelines/templates/steps/resolve-package-targeting.yml
            parameters:
              BuildTargetingString: ${{ parameters.BuildTargetingString }}
              PackagePropertiesFolder: $(Build.ArtifactStagingDirectory)/PackageInfo

          - template: /eng/pipelines/templates/steps/analyze.yml
            parameters:
              RustToolchain: ${{ RustToolchain }}

          - template: /eng/common/pipelines/templates/steps/check-spelling.yml
            parameters:
              ContinueOnError: false

          - template: /eng/common/pipelines/templates/steps/verify-links.yml
            parameters:
              ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
                Directory: ""
                Urls: (eng/common/scripts/get-markdown-files-from-changed-files.ps1)
              ${{ elseif eq(parameters.ServiceDirectory, 'auto') }}:
                Directory: ""
              ${{ else }}:
                Directory: sdk/${{ parameters.ServiceDirectory }}
              CheckLinkGuidance: $true
              Condition: succeededOrFailed()
